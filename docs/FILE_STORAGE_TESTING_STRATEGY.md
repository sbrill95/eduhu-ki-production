# File Storage Testing Strategy\n\n## Overview\n\nThis document outlines the comprehensive testing strategy for the eduhu.ki file storage and serving functionality. The testing strategy covers both the S3 storage adapter implementation and the enhanced file serving API route.\n\n## Architecture Under Test\n\n### Components Tested\n\n1. **S3 Storage Adapter** (`src/lib/file-storage.ts`)\n   - Cloud storage operations (upload, download, delete)\n   - Local storage fallback functionality\n   - File validation and security measures\n   - Thumbnail generation and storage\n\n2. **File Serving API Route** (`src/app/api/files/[...path]/route.ts`)\n   - GET and HEAD request handling\n   - Authentication and authorization\n   - Local storage and S3 fallback logic\n   - Analytics logging\n   - Security measures (path traversal prevention)\n\n3. **Database Integration** (`src/lib/database.ts`)\n   - Session validation\n   - File ownership verification\n   - Analytics data persistence\n\n## Test Categories\n\n### 1. Unit Tests\n\n**Location:** `src/lib/__tests__/file-storage.test.ts`\n\n**Purpose:** Test individual functions and components in isolation\n\n**Coverage Areas:**\n- S3StorageAdapter class methods\n- File validation functions\n- Utility functions (filename generation, headers, etc.)\n- Storage adapter factory functions\n- Error handling for individual operations\n\n**Key Test Scenarios:**\n- S3 configuration validation\n- File upload/download operations\n- Error handling (access denied, network issues, etc.)\n- File validation (size, type, security)\n- Local storage operations\n\n### 2. Integration Tests\n\n**Location:** `tests/integration/`\n\n#### File Serving API Tests\n**File:** `file-serving-api.test.ts`\n\n**Purpose:** Test the complete file serving workflow\n\n**Coverage Areas:**\n- Request routing and parameter handling\n- Authentication and authorization flows\n- Local storage and S3 fallback integration\n- Content type detection and response headers\n- Analytics logging integration\n\n#### Error Handling Tests\n**File:** `file-serving-errors.test.ts`\n\n**Purpose:** Test error scenarios and edge cases\n\n**Coverage Areas:**\n- File system errors (ENOENT, EACCES, EMFILE)\n- Database connection failures\n- S3 service errors and timeouts\n- Resource exhaustion scenarios\n- Recovery and fallback mechanisms\n\n#### Analytics Validation Tests\n**File:** `analytics-validation.test.ts`\n\n**Purpose:** Verify proper analytics logging\n\n**Coverage Areas:**\n- Successful file access logging\n- Failed access attempt logging\n- Performance impact of analytics\n- Data quality and accuracy\n\n### 3. Security Tests\n\n**Location:** `tests/security/file-serving-security.test.ts`\n\n**Purpose:** Validate security measures and access controls\n\n**Coverage Areas:**\n- Path traversal prevention\n- Authentication and authorization\n- Input validation and sanitization\n- File upload security\n- Response header security\n- Information disclosure prevention\n\n**Key Security Scenarios:**\n- Path traversal attempts (`../../../etc/passwd`)\n- Malicious filename handling\n- Unauthorized access attempts\n- Session hijacking prevention\n- File extension validation\n\n### 4. Performance Tests\n\n**Location:** `tests/performance/file-operations.test.ts`\n\n**Purpose:** Validate performance requirements and identify bottlenecks\n\n**Coverage Areas:**\n- Individual file response times\n- Concurrent request handling\n- Memory usage and resource consumption\n- S3 fallback performance\n- Analytics logging impact\n\n**Performance Thresholds:**\n- Small files (≤10KB): <500ms response time\n- Large files (>1MB): <2000ms response time\n- Concurrent requests: <5000ms for 10 concurrent requests\n- Memory usage: <100MB during normal operation\n\n## Test Environment Setup\n\n### Prerequisites\n\n1. **Node.js and npm** - Latest LTS version\n2. **Jest** - Testing framework\n3. **Playwright** - End-to-end testing\n4. **Test database** - Mock InstantDB setup\n\n### Environment Configuration\n\n```bash\n# Install dependencies\nnpm install\n\n# Setup test environment variables\ncp .env.example .env.test\n\n# Configure test-specific settings\nexport NODE_ENV=test\nexport TEST_BASE_URL=http://localhost:3000\n```\n\n### Mock Configuration\n\nThe test suite uses comprehensive mocking to isolate components:\n\n- **AWS SDK**: Mocked S3 client and operations\n- **File System**: Mocked fs/promises operations\n- **Database**: Mocked InstantDB queries and transactions\n- **Network**: Mocked fetch operations for S3 fallback\n\n## Test Execution\n\n### Running All Tests\n\n```bash\n# Run complete test suite\nnpm run test:all\n\n# Run with coverage report\nnpm run test:coverage\n\n# Run in CI environment\nnpm run test:ci\n```\n\n### Running Specific Test Categories\n\n```bash\n# Unit tests only\nnpm run test:unit\n\n# Integration tests\nnpm run test:integration\n\n# Security tests\nnpm run test:security\n\n# Performance tests\nnpm run test:performance\n\n# End-to-end tests\nnpm run test:e2e\n```\n\n### Running Individual Test Files\n\n```bash\n# File storage unit tests\nnpm test src/lib/__tests__/file-storage.test.ts\n\n# File serving API integration tests\nnpm test tests/integration/file-serving-api.test.ts\n\n# Security tests\nnpm test tests/security/file-serving-security.test.ts\n\n# Performance tests\nnpx playwright test tests/performance/file-operations.test.ts\n\n# Analytics validation\nnpm test tests/integration/analytics-validation.test.ts\n```\n\n## Success Criteria\n\n### Test Coverage Requirements\n\n- **Overall Coverage**: ≥90%\n- **Function Coverage**: ≥95%\n- **Branch Coverage**: ≥85%\n- **Line Coverage**: ≥90%\n\n### Functional Requirements\n\n#### File Storage Operations\n- ✅ Successfully upload files to S3 when configured\n- ✅ Fallback to local storage when S3 unavailable\n- ✅ Generate secure filenames with proper structure\n- ✅ Validate file types and sizes before storage\n- ✅ Handle thumbnail generation and storage\n- ✅ Provide accurate file metadata\n\n#### File Serving Operations\n- ✅ Serve files with correct content types\n- ✅ Implement proper caching headers\n- ✅ Handle both GET and HEAD requests\n- ✅ Support local and S3 storage sources\n- ✅ Log analytics for authenticated requests\n- ✅ Prevent unauthorized access\n\n#### Security Requirements\n- ✅ Block all path traversal attempts\n- ✅ Validate file ownership before serving\n- ✅ Sanitize all user input\n- ✅ Set appropriate security headers\n- ✅ Prevent information disclosure\n- ✅ Handle malicious filenames safely\n\n#### Performance Requirements\n- ✅ Small files served within 500ms\n- ✅ Large files served within 2000ms\n- ✅ Handle 10+ concurrent requests efficiently\n- ✅ Memory usage stays below 100MB\n- ✅ Analytics logging adds <200ms overhead\n\n### Error Handling Requirements\n\n- ✅ Graceful degradation when components fail\n- ✅ Appropriate HTTP status codes\n- ✅ No internal error details exposed\n- ✅ Consistent error message format\n- ✅ Proper logging of all errors\n\n## Continuous Integration\n\n### GitHub Actions Workflow\n\nThe test suite integrates with GitHub Actions for automated testing:\n\n```yaml\n# .github/workflows/test.yml\nname: Test Suite\non: [push, pull_request]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n      - uses: actions/setup-node@v3\n        with:\n          node-version: '18'\n      - run: npm ci\n      - run: npm run test:ci\n      - run: npm run test:e2e\n```\n\n### Quality Gates\n\nPull requests must pass all quality gates:\n\n1. **All tests pass** (100% pass rate required)\n2. **Coverage thresholds met** (≥90% overall)\n3. **No security vulnerabilities** (npm audit clean)\n4. **Performance benchmarks met** (response time thresholds)\n5. **Linting passes** (ESLint + Prettier)\n\n## Test Data Management\n\n### Test File Creation\n\nTests automatically create and clean up test files:\n\n```typescript\n// Example test file creation\nconst testFiles = [\n  { name: 'small-1kb.txt', size: 1024 },\n  { name: 'medium-100kb.txt', size: 100 * 1024 },\n  { name: 'large-1mb.txt', size: 1024 * 1024 }\n]\n\nawait createTestFiles(uploadsDir, testFiles)\n```\n\n### Mock Data Factories\n\n```typescript\n// File record factory\nconst createFileRecord = (overrides = {}) => ({\n  id: 'test-file-id',\n  filename: 'test.txt',\n  teacher_id: 'test-teacher',\n  file_path: '2024/01/test.txt',\n  ...overrides\n})\n```\n\n## Debugging and Troubleshooting\n\n### Common Test Failures\n\n1. **Mock Configuration Issues**\n   ```bash\n   # Clear Jest cache\n   npx jest --clearCache\n   \n   # Run with verbose output\n   npm test -- --verbose\n   ```\n\n2. **Environment Variable Issues**\n   ```bash\n   # Check environment setup\n   env | grep TEST_\n   env | grep AWS_\n   ```\n\n3. **File System Permission Issues**\n   ```bash\n   # Check uploads directory permissions\n   ls -la uploads/\n   \n   # Create directory if needed\n   mkdir -p uploads/2024/12\n   ```\n\n### Performance Debugging\n\n```bash\n# Run performance tests with detailed timing\nnpx playwright test tests/performance/ --reporter=line\n\n# Profile memory usage\nnode --expose-gc --inspect test-memory-usage.js\n```\n\n### Security Test Debugging\n\n```bash\n# Run security tests in isolation\nnpm test tests/security/ -- --runInBand\n\n# Enable debug logging\nDEBUG=file-storage:* npm test\n```\n\n## Reporting and Metrics\n\n### Test Reports\n\nThe test suite generates comprehensive reports:\n\n- **Coverage Report**: `coverage/lcov-report/index.html`\n- **Performance Report**: `test-results/performance-report.json`\n- **Security Report**: `test-results/security-report.json`\n- **JUnit Report**: `test-results/junit.xml` (for CI integration)\n\n### Metrics Tracking\n\nKey metrics monitored:\n\n- Test execution time trends\n- Coverage percentage over time\n- Performance benchmark results\n- Flaky test identification\n- Security issue detection\n\n## Maintenance and Updates\n\n### Regular Maintenance Tasks\n\n1. **Weekly**: Review test results and address flaky tests\n2. **Monthly**: Update performance benchmarks based on requirements\n3. **Quarterly**: Review and update security test scenarios\n4. **Per Release**: Validate all tests pass with new dependencies\n\n### Test Suite Evolution\n\nAs the file storage system evolves:\n\n1. Add new tests for new features\n2. Update existing tests for changed behavior\n3. Remove obsolete tests for deprecated features\n4. Maintain test documentation\n5. Update performance thresholds as needed\n\n## Conclusion\n\nThis comprehensive testing strategy ensures the reliability, security, and performance of the eduhu.ki file storage system. The multi-layered approach provides confidence in the system's behavior across all scenarios and edge cases.\n\nFor questions or issues with the test suite, refer to:\n- Test utility documentation in `tests/utils/`\n- Mock setup examples in test files\n- CI/CD pipeline configuration in `.github/workflows/`\n- Performance benchmarking results in `test-results/`"