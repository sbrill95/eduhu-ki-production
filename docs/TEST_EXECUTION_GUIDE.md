# Test Execution Guide - File Storage Testing\n\n## Quick Start\n\n### Prerequisites Check\n\n```bash\n# Verify Node.js version (should be 18+)\nnode --version\n\n# Verify npm version\nnpm --version\n\n# Check if project dependencies are installed\nls node_modules/ | head -5\n```\n\n### Environment Setup\n\n```bash\n# Install all dependencies\nnpm install\n\n# Verify test environment\nnpm run test -- --listTests | grep file-storage\n```\n\n## Test Execution Commands\n\n### 1. Unit Tests\n\n**Command:**\n```bash\nnpm test src/lib/__tests__/file-storage.test.ts\n```\n\n**Expected Output:**\n```\n✓ S3StorageAdapter › Configuration › should initialize with proper configuration\n✓ S3StorageAdapter › Configuration › should detect missing configuration\n✓ S3StorageAdapter › saveFile › should upload file to S3 successfully\n✓ S3StorageAdapter › saveFile › should handle S3 access denied error\n✓ Local Storage Functions › saveFileToStorage › should save file to local storage successfully\n✓ Utility Functions › generateSecureFilename › should generate secure filename with timestamp\n✓ File Validation › should validate acceptable files\n✓ File Validation › should reject files with dangerous extensions\n\nTest Suites: 1 passed, 1 total\nTests:       45 passed, 45 total\nTime:        3.847s\n```\n\n**Success Criteria:**\n- ✅ All tests pass (100% pass rate)\n- ✅ Test execution time < 10 seconds\n- ✅ No memory leaks or hanging processes\n\n### 2. Integration Tests\n\n**File Serving API Tests:**\n```bash\nnpm test tests/integration/file-serving-api.test.ts\n```\n\n**Expected Output:**\n```\n✓ Security Validation › should reject empty file paths\n✓ Security Validation › should reject path traversal attempts\n✓ Local Storage File Serving › should serve file from local storage successfully\n✓ S3 Storage Fallback › should fallback to S3 when local file not found\n✓ Analytics Logging › should log successful file access analytics\n✓ HEAD Request Support › should respond to HEAD requests with headers only\n\nTest Suites: 1 passed, 1 total\nTests:       28 passed, 28 total\nTime:        5.234s\n```\n\n**Error Handling Tests:**\n```bash\nnpm test tests/integration/file-serving-errors.test.ts\n```\n\n**Expected Output:**\n```\n✓ File System Error Handling › should handle ENOENT (file not found) gracefully\n✓ Database Error Handling › should continue serving files when database query fails\n✓ S3 Error Handling › should handle S3 access denied errors\n✓ Edge Cases › should handle extremely large file paths\n✓ Recovery Scenarios › should recover from temporary file system issues\n\nTest Suites: 1 passed, 1 total\nTests:       22 passed, 22 total\nTime:        4.567s\n```\n\n**Analytics Validation Tests:**\n```bash\nnpm test tests/integration/analytics-validation.test.ts\n```\n\n**Expected Output:**\n```\n✓ Successful File Access Analytics › should log analytics for authenticated file access with session\n✓ Failed File Access Analytics › should log analytics for file not found errors\n✓ Analytics Data Quality › should include accurate response times in analytics\n✓ Analytics Performance Impact › should not significantly impact response time\n\nTest Suites: 1 passed, 1 total\nTests:       15 passed, 15 total\nTime:        6.123s\n```\n\n### 3. Security Tests\n\n**Command:**\n```bash\nnpm test tests/security/file-serving-security.test.ts\n```\n\n**Expected Output:**\n```\n✓ Path Traversal Prevention › should block simple path traversal with ../../../\n✓ Authentication and Authorization › should validate teacher ID when provided\n✓ Input Validation › should reject malformed teacher IDs\n✓ File Upload Validation › should reject dangerous file extensions\n✓ Response Header Security › should include security headers in all responses\n✓ Information Disclosure Prevention › should not reveal file existence through timing attacks\n\nTest Suites: 1 passed, 1 total\nTests:       32 passed, 32 total\nTime:        7.891s\n```\n\n**Success Criteria:**\n- ✅ All security tests pass\n- ✅ No path traversal vulnerabilities\n- ✅ Proper access control enforcement\n- ✅ No information disclosure\n\n### 4. Performance Tests\n\n**Command:**\n```bash\nnpx playwright test tests/performance/file-operations.test.ts\n```\n\n**Expected Output:**\n```\n✓ Individual File Response Times › should serve small-1kb.txt within performance threshold (245ms)\n✓ Individual File Response Times › should serve medium-100kb.txt within performance threshold (423ms)\n✓ Individual File Response Times › should serve large-1mb.txt within performance threshold (1234ms)\n✓ Concurrent Request Performance › should handle multiple concurrent requests efficiently\n✓ Content Type Detection › should detect content types quickly\n\nPassed: 15/15 tests\nTime: 45.67s\n```\n\n**Performance Benchmarks:**\n- ✅ Small files (≤10KB): Response time < 500ms\n- ✅ Medium files (100KB): Response time < 1000ms\n- ✅ Large files (1MB+): Response time < 2000ms\n- ✅ Concurrent requests (10x): Total time < 5000ms\n- ✅ HEAD requests: Response time < 200ms\n\n### 5. Complete Test Suite\n\n**Command:**\n```bash\nnpm run test:all\n```\n\n**Expected Output Summary:**\n```\n=============================== Coverage summary ===============================\nStatements   : 92.45% ( 247/267 )\nBranches     : 87.23% ( 123/141 )\nFunctions    : 95.12% ( 78/82 )\nLines        : 91.67% ( 220/240 )\n================================================================================\n\nTest Suites: 5 passed, 5 total\nTests:       112 passed, 112 total\nSnapshots:   0 total\nTime:        27.456s, estimated 30s\n```\n\n## Detailed Success Criteria\n\n### Test Coverage Requirements\n\n**Minimum Acceptable Coverage:**\n- Overall Coverage: ≥90% ✅\n- Function Coverage: ≥95% ✅\n- Branch Coverage: ≥85% ✅\n- Line Coverage: ≥90% ✅\n\n**Coverage Verification:**\n```bash\n# Generate coverage report\nnpm run test:coverage\n\n# Open coverage report in browser\nopen coverage/lcov-report/index.html\n```\n\n### Performance Acceptance Criteria\n\n| Test Scenario | Threshold | Measurement |\n|---------------|-----------|-------------|\n| Small file serving (1KB) | <500ms | Response time |\n| Medium file serving (100KB) | <1000ms | Response time |\n| Large file serving (1MB) | <2000ms | Response time |\n| Very large file serving (5MB) | <5000ms | Response time |\n| HEAD request | <200ms | Response time |\n| Concurrent requests (10x) | <5000ms | Total time |\n| Memory usage during operation | <100MB | Peak memory |\n| Analytics logging overhead | <200ms | Additional latency |\n\n### Security Validation Checklist\n\n**Path Traversal Prevention:**\n- ✅ Block `../../../etc/passwd`\n- ✅ Block URL encoded traversal `%2e%2e%2f`\n- ✅ Block Windows paths `..\\\\..\\\\windows`\n- ✅ Block tilde paths `~/user/.ssh`\n- ✅ Block absolute paths `/etc/passwd`\n- ✅ Block null byte injection `file.txt\\x00.exe`\n\n**Access Control:**\n- ✅ Validate file ownership\n- ✅ Enforce session permissions\n- ✅ Reject unauthorized access attempts\n- ✅ Handle malformed authentication\n\n**Input Validation:**\n- ✅ Sanitize file paths\n- ✅ Validate teacher IDs\n- ✅ Validate session IDs\n- ✅ Handle special characters\n\n**Response Security:**\n- ✅ Set `X-Content-Type-Options: nosniff`\n- ✅ Set `X-Frame-Options: DENY`\n- ✅ Proper content disposition headers\n- ✅ No internal path disclosure\n\n### Functional Requirements Validation\n\n**File Storage Operations:**\n- ✅ S3 upload with proper metadata\n- ✅ Local storage fallback\n- ✅ File validation (size, type, security)\n- ✅ Secure filename generation\n- ✅ Thumbnail creation and storage\n- ✅ File deletion and cleanup\n\n**File Serving Operations:**\n- ✅ Correct content type detection\n- ✅ Proper HTTP headers\n- ✅ Local and S3 source handling\n- ✅ Thumbnail serving\n- ✅ HEAD request support\n- ✅ Error response formatting\n\n**Analytics and Monitoring:**\n- ✅ Successful access logging\n- ✅ Failed access logging\n- ✅ Performance metrics\n- ✅ Error tracking\n- ✅ No PII in logs\n\n## Troubleshooting Guide\n\n### Common Test Failures\n\n**1. Mock Configuration Issues**\n\n**Symptoms:**\n```\nError: Cannot find module '@aws-sdk/client-s3'\nTypeError: jest.fn() is not a function\n```\n\n**Solution:**\n```bash\n# Clear Jest cache\nnpx jest --clearCache\n\n# Reinstall dependencies\nrm -rf node_modules package-lock.json\nnpm install\n\n# Run single test to debug\nnpm test -- --testNamePattern=\"should initialize\" --verbose\n```\n\n**2. Environment Variable Issues**\n\n**Symptoms:**\n```\nS3 adapter configuration test failing\nUnexpected storage type returned\n```\n\n**Solution:**\n```bash\n# Check environment variables\necho $NODE_ENV\necho $AWS_ACCESS_KEY_ID\n\n# Reset environment\nunset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_S3_BUCKET_NAME\n\n# Run tests with clean environment\nenv -i npm test\n```\n\n**3. File System Permission Issues**\n\n**Symptoms:**\n```\nEACCES: permission denied, mkdir 'uploads'\nEMFILE: too many open files\n```\n\n**Solution:**\n```bash\n# Check permissions\nls -la uploads/\n\n# Create directory with proper permissions\nmkdir -p uploads/2024/12\nchmod 755 uploads/\n\n# Check file descriptor limits\nulimit -n\n```\n\n**4. Performance Test Timeouts**\n\n**Symptoms:**\n```\nTest timeout in setupTestFiles\nPlaywright test exceeded 30000ms\n```\n\n**Solution:**\n```bash\n# Run with increased timeout\nnpx playwright test --timeout=60000\n\n# Run performance tests individually\nnpx playwright test tests/performance/file-operations.test.ts --grep=\"small file\"\n\n# Check system resources\ntop | grep node\n```\n\n### Debug Commands\n\n**Verbose Test Output:**\n```bash\nnpm test -- --verbose --no-cache\n```\n\n**Debug Specific Test:**\n```bash\nnpm test -- --testNamePattern=\"S3 upload\" --runInBand --verbose\n```\n\n**Memory and Performance Debugging:**\n```bash\n# Run with memory profiling\nnode --expose-gc --inspect tests/debug-memory.js\n\n# Monitor file descriptors\nlsof | grep node | wc -l\n```\n\n**Mock Debugging:**\n```bash\n# Enable mock debugging\nDEBUG=jest:* npm test\n\n# Check mock call history\nconsole.log(mockFunction.mock.calls)\n```\n\n## Continuous Integration\n\n### Local CI Simulation\n\n```bash\n# Simulate CI environment\nenv NODE_ENV=test CI=true npm run test:ci\n```\n\n### Pre-commit Validation\n\n```bash\n# Run full validation suite\nnpm run qa:full\n```\n\n**Expected CI Pipeline Results:**\n- ✅ All tests pass (112/112)\n- ✅ Coverage thresholds met (≥90%)\n- ✅ Security audit clean\n- ✅ Performance benchmarks met\n- ✅ Linting passes\n- ✅ No dependency vulnerabilities\n\n## Test Maintenance\n\n### Weekly Maintenance\n\n```bash\n# Update test snapshots if needed\nnpm test -- --updateSnapshot\n\n# Check for flaky tests\nnpm test -- --detectOpenHandles\n\n# Performance benchmark update\nnpm run test:performance -- --reporter=json > benchmarks/$(date +%Y-%m-%d).json\n```\n\n### Monthly Maintenance\n\n```bash\n# Dependency security audit\nnpm audit --audit-level=high\n\n# Update test fixtures\nnpm run generate:test-fixtures\n\n# Review coverage gaps\nnpm run test:coverage -- --reporter=json | jq '.uncoveredLines'\n```\n\nThis guide provides everything needed to execute and validate the file storage testing strategy. Follow the commands and success criteria to ensure the system meets all requirements."